<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard OSs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #111;
      color: white;
      scrollbar-width: thin;
      scrollbar-color: #555 #1e1e1e; /* al√ßa da rolagem / trilha */
    }

    .sidebar-hibrido {
      position: fixed;
      top: 0;
      left: 0;
      width: 350px;
      height: 100vh;
      background-color: #1e1e1e;
      transition: all 0.3s;
      z-index: 1040;
      overflow: hidden;
    }

    .sidebar-hibrido.minimized {
      width: 50px;
    }

    .sidebar-hibrido .toggle-btn {
      position: absolute;
      top: 10px;
      right: 20px;
      background-color: #1e1e1e;
      border: 1px solid #444;
      border-radius: 0 5px 5px 0;
      color: white;
      padding: 2px 8px;
      cursor: pointer;
      z-index: 1050;
    }

    .sidebar-hibrido .menu-content {
      padding: 10px;
      height: 100%;
      overflow-y: auto;
    }

    .sidebar-hibrido.minimized .menu-content {
      display: none;
    }

    .kpi-card {
      background-color: #1e1e1e;
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 2px 2px 10px #00000033;
      margin-bottom: 10px;
      height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .kpi-title {
      color: #aaa;
      font-size: 12px;
      text-align: center;
    }

    .kpi-value {
      margin: 0;
      color: white;
      font-size: 25px;
      font-weight: bold;
      text-align: center;
    }

    a {
      color: white;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    table {
      background-color: white;
      color: black;
      font-size: 12px;
    }

    details {
      font-size: 11px;
    }

    summary {
      font-size: 12px;
    }

    .content-wrapper {
      margin-left: 400px;
      transition: margin-left 0.3s;
    }

    .kpi-section {
      background-color: #222;
      padding: 10px 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #0d6efd;
    }

    .kpi-section h5 {
      margin-bottom: 10px;
      font-weight: bold;
    }

    .collapsible .collapsible-header {
      cursor: pointer;
      user-select: none;
    }

    .collapsible .collapsible-content {
      display: block;
      transition: max-height 0.3s ease;
      overflow: hidden;
    }

    .collapsible.collapsed .collapsible-content {
      display: none;
    }

    /* Estilo geral para navegadores baseados em WebKit (Chrome, Edge, Safari) */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #1e1e1e; /* cor do fundo da trilha da rolagem */
  }

  ::-webkit-scrollbar-thumb {
    background-color: #555; /* cor da al√ßa da rolagem */
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background-color: #777; /* cor ao passar o mouse */
  }
  </style>
</head>
<body>
  <!-- Sidebar hibrida -->
  <div id="sidebar" class="sidebar-hibrido">
    <div class="toggle-btn" onclick="toggleSidebar()">
      <i class="bi bi-chevron-left"></i>
    </div>
    <div class="menu-content">
      <h5>üìÅ Menu</h5>
      <div id="menu-tree"></div>
    </div>
  </div>

  <div class="content-wrapper">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12">
          <h2 class="mt-3">üìä Dashboard <span id="sistema-titulo" class="mb-0"></span></h2>

          <!-- KPIs principais -->
          <div class="row my-3">
            <div class="col-md-4"><div class="kpi-card"><div class="kpi-title" style="font-size: 20px;">üåê Total de OS</div><div class="kpi-value" id="total-os" style="font-size: 25px;">0</div></div></div>
            <div class="col-md-4"><div class="kpi-card"><div class="kpi-title" style="font-size: 20px;">üì¶ PF Bruto</div><div class="kpi-value" id="pf-bruto" style="font-size: 25px;">0</div></div></div>
            <div class="col-md-4"><div class="kpi-card"><div class="kpi-title" style="font-size: 20px;">üßÆ PF L√≠quido</div><div class="kpi-value" id="pf-liquido" style="font-size: 25px;">0</div></div></div>
          </div>

          <!-- KPIs por Fase -->
          <div class="kpi-section collapsible">
            <h5 class="collapsible-header text-light">üìÇ Fase</h5>
            <div class="collapsible-content">
              <div class="row my-2" id="fase-kpis">
                <!-- Conte√∫do 1 -->
              </div>
            </div>
          </div>

          <!-- KPIs por Status -->
          <div class="kpi-section collapsible">
            <h5 class="collapsible-header text-light">‚ö†Ô∏è Status</h5>
            <div class="collapsible-content">
              <div class="row my-2" id="status-kpis"></div>
            </div>
          </div>

          <!-- KPIs por Servi√ßo -->
          <div class="kpi-section collapsible">
            <h5 class="collapsible-header text-light">üöö Servi√ßo</h5>
            <div class="collapsible-content">
              <div class="row my-2" id="servico-kpis"></div>
            </div>
          </div>

          <!-- Tabela -->
          <div class="mt-4">
            <div class="d-flex align-items-center justify-content-between">
              <h4 id="tabela-titulo" class="mb-0">üìä Sistema: <span style="color:#0d6efd; font-weight:bold">(nenhum)</span></h4>
              <button class="btn btn-sm btn-outline-light" onclick="selecionarSistema('')">Limpar filtro</button>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-bordered mt-3">
                <thead class="table-dark">
                  <tr>
                    <th>OS</th>
                    <th>Respons√°vel</th>
                    <th>Servi√ßo</th>
                    <th>% Fase</th>
                    <th>PF Bruto</th>
                    <th>PF L√≠quido</th>
                    <th>Status</th>
                    <th>DT Entrega Atual SGAT</th>
                    <th>OBS</th>
                  </tr>
                </thead>
                <tbody id="os-table-body">
                  <tr><td colspan="7">Selecione um sistema na √°rvore para ver os dados.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const icon = sidebar.querySelector(".toggle-btn i");
      const content = document.querySelector(".content-wrapper");

      sidebar.classList.toggle("minimized");
      icon.classList.toggle("bi-chevron-left");
      icon.classList.toggle("bi-chevron-right");

      if (sidebar.classList.contains("minimized")) {
        content.style.marginLeft = "50px";
      } else {
        content.style.marginLeft = "410px";
      }
    }

    let osData = [];

    async function carregarDados() {
      const [arvore, os] = await Promise.all([
        fetch("./dados/pessoas_sistemas.json").then(r => r.json()),
        fetch("./dados/os.json").then(r => r.json())
      ]);
      osData = os;
      gerarArvore(arvore, document.getElementById("menu-tree"));
      selecionarSistema("");
    }

    function gerarArvore(nos, container) {
      nos.forEach(no => {
        const wrapper = document.createElement("div");
        wrapper.style.marginLeft = "5px";

        if (no.tipo === "pasta") {
          const details = document.createElement("details");
          details.open = true;
          const summary = document.createElement("summary");
          summary.innerHTML = no.nome === "nan" ? "<span style='font-size:10px'>(n√£o informado)</span>" : no.nome;
          details.appendChild(summary);
          gerarArvore(no.filhos, details);
          wrapper.appendChild(details);
        } else if (no.tipo === "sistema") {
          const nomeSistema = no.nome === "nan" ? "<span style='font-size:10px'>(n√£o informado)</span>" : no.nome;
          const qtdOS = osData.filter(os => (os.Sistema || "").trim() === no.nome.trim()).length;
          const details = document.createElement("details");
          const summary = document.createElement("summary");
          summary.innerHTML = `üìä <a href="#" onclick="selecionarSistema('${no.nome}')">${nomeSistema}</a> <span style="color:red">${qtdOS}</span>`;
          details.appendChild(summary);
          wrapper.appendChild(details);
        }

        container.appendChild(wrapper);
      });
    }

    function selecionarSistema(sistema = "") {
      const filtrado = sistema ? osData.filter(o => (o.Sistema || "").trim() === sistema.trim()) : osData;
      document.getElementById("tabela-titulo").innerHTML = `Sistema: <span style="color:#0d6efd; font-weight:bold">${sistema || "(todos)"}</span>`;
      document.getElementById("sistema-titulo").innerHTML = `Sistema <span style="font-weight:bold">${sistema || "(todos)"}</span>`;
      document.getElementById("total-os").innerText = filtrado.length;
      //document.getElementById("total-gm").innerText = filtrado.filter(o => (o.Servi√ßo || "").toUpperCase() === "GM").length;
      document.getElementById("pf-bruto").innerText = somaCampo(filtrado, "PF Bruto");
      document.getElementById("pf-liquido").innerText = somaCampo(filtrado, "PF L√≠quido");
      //document.getElementById("os-atrasadas").innerText = filtrado.filter(o => ((o["Status"] || "").toUpperCase().includes("ATRASAD"))).length;

      const corpoTabela = document.getElementById("os-table-body");
      corpoTabela.innerHTML = "";
      filtrado.forEach(os => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${os.OS}</td>
          <td>${os.Resp}</td>
          <td>${os.Servi√ßo}</td>
          <td>${os["% Fases"]}</td>
          <td>${formatarValor(os["PF Bruto"])}</td>
          <td>${formatarValor(os["PF L√≠quido"])}</td>
          <td>${os["Status"]}</td>
          <td>${os["DT Entrega Atual SGAT"]}</td>
          <td>${os.OBS ? `<span style="cursor: pointer;" title="${os.OBS.replace(/"/g, '&quot;')}">‚ö†Ô∏è</span>` : ''}</td>
        `;
        corpoTabela.appendChild(tr);
      });

      gerarCardsKPI("fase-kpis", filtrado, "Fases");
      gerarCardsKPI("status-kpis", filtrado, "Status");
      gerarCardsKPI("servico-kpis", filtrado, "Servi√ßo");
    }

    function somaCampo(lista, campo) {
      return lista.reduce((soma, item) => soma + Number(item[campo] || 0), 0).toLocaleString("pt-BR", { maximumFractionDigits: 0 });
    }

    function formatarValor(valor) {
      return Number(valor || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    document.addEventListener('DOMContentLoaded', function () {
      const allCollapsibles = document.querySelectorAll('.collapsible');

      allCollapsibles.forEach(section => {
        const header = section.querySelector('.collapsible-header');
        header.addEventListener('click', () => {
          section.classList.toggle('collapsed');
        });
      });
    });

    function gerarCardsKPI(idContainer, lista, campo) {
      const container = document.getElementById(idContainer);
      container.innerHTML = "";
      const contagem = {};
      lista.forEach(item => {
        const valor = (item[campo] || "(vazio)").trim();
        contagem[valor] = (contagem[valor] || 0) + 1;
      });
      Object.entries(contagem).forEach(([chave, valor]) => {
        const col = document.createElement("div");
        col.className = "col-md-2";
        col.innerHTML = `
          <div class="kpi-card kpi-filtro" data-campo="${campo}" data-valor="${chave}" style="cursor:pointer">
            <div class="kpi-title">${chave}</div>
            <div class="kpi-value">${valor}</div>
          </div>
        `;
        container.appendChild(col);
      });

      container.querySelectorAll(".kpi-filtro").forEach(card => {
        card.addEventListener("click", () => {
          const campo = card.getAttribute("data-campo");
          const valor = card.getAttribute("data-valor");

          const filtrado = lista.filter(item => (item[campo] || "").trim() === valor);
          const corpoTabela = document.getElementById("os-table-body");
          corpoTabela.innerHTML = "";
          filtrado.forEach(os => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${os.OS}</td>
              <td>${os.Resp}</td>
              <td>${os.Servi√ßo}</td>
              <td>${os["% Fases"]}</td>
              <td>${formatarValor(os["PF Bruto"])}</td>
              <td>${formatarValor(os["PF L√≠quido"])}</td>
              <td>${os["Status"]}</td>
              <td>${os["DT Entrega Atual SGAT"]}</td>
              <td>${os.OBS ? `<span style="cursor: pointer;" title="${os.OBS.replace(/"/g, '&quot;')}">‚ö†Ô∏è</span>` : ''}</td>`;
            corpoTabela.appendChild(tr);
          });
        });
      });
    }

    carregarDados();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
